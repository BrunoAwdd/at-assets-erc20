stages:
  - deploy

deploy_production:
  stage: deploy
  only:
    - main # Executa apenas na branch `main`
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_SERVER_IP >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Iniciando deploy no servidor $DEPLOY_SERVER_IP"

    # Enviar apenas a pasta asset-token-interface para o servidor
    - rsync -avz --delete ./asset-token-interface/ rails@$DEPLOY_SERVER_IP:/home/rails/at-assets-erc20/

    # Acessar o servidor e rodar comandos de atualizaÃ§Ã£o
    - >
      ssh -i ~/.ssh/id_rsa rails@$DEPLOY_SERVER_IP << 'EOF'
        set -e  # Para imediatamente em caso de erro

        # Ir para a pasta de destino
        cd /home/rails/at-assets-erc20/

        # Instalar dependÃªncias
        npm install --production

        # Fazer build do projeto
        npm run build

        # Reiniciar o serviÃ§o Next.js
        sudo systemctl restart nextjs
      EOF
